<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflect AI - Understand Your Conversations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .settings-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .setting-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-methods {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .method-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .method-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .method-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .input-section {
            margin-bottom: 30px;
        }

        .recording-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .record-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .record-btn.start {
            background: #28a745;
            color: white;
        }

        .record-btn.stop {
            background: #dc3545;
            color: white;
        }

        .record-btn:hover {
            transform: scale(1.05);
        }

        .record-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .transcript-section {
            margin-bottom: 30px;
        }

        .transcript-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .speaker-line {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: white;
            border-left: 4px solid #667eea;
        }

        .speaker-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .speaker-text {
            color: #333;
            line-height: 1.4;
        }

        .speaker-management {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .speaker-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .speaker-label {
            min-width: 80px;
            font-weight: 600;
        }

        .speaker-name-input {
            flex: 1;
            max-width: 200px;
        }

        .is-me-checkbox {
            width: auto;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        .action-btn.summary {
            background: #17a2b8;
            color: white;
        }

        .action-btn.analyze {
            background: #6f42c1;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .result-content {
            line-height: 1.6;
            color: #555;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .model-tooltip {
            margin-top: 8px;
            padding: 10px;
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            font-size: 14px;
            color: #0c5460;
            line-height: 1.4;
        }

        .model-tooltip strong {
            color: #084298;
        }

        .ai-model-info {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #856404;
        }

        .ai-model-info .model-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .model-option {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .model-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .model-option h4 {
            margin: 0 0 8px 0;
            color: #333;
        }

        .model-option p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .settings-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .input-methods {
                flex-direction: column;
            }
            
            .recording-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Reflect AI</h1>
            <p>Understand your conversations, discover yourself</p>
        </div>

        <div class="main-card">
            <!-- Settings Section -->
            <div class="settings-section">
                <h2>Settings</h2>
                <div class="settings-row">
                    <div class="setting-group">
                        <label for="userName">Your Name:</label>
                        <input type="text" id="userName" placeholder="Enter your name">
                    </div>
                    <div class="setting-group">
                        <label for="conversationLanguage">Conversation Language:</label>
                        <select id="conversationLanguage">
                            <option value="en">English</option>
                            <option value="he">Hebrew</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label for="analysisLanguage">Analysis Language:</label>
                        <select id="analysisLanguage">
                            <option value="en">English</option>
                            <option value="he">Hebrew</option>
                        </select>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-group">
                        <label for="relationshipType">Relationship Type:</label>
                        <select id="relationshipType">
                            <option value="romantic">💕 Romantic Partners</option>
                            <option value="parent-child">👨‍👩‍👧‍👦 Parent - Child</option>
                            <option value="friends">👥 Friends</option>
                            <option value="colleagues">💼 Colleagues</option>
                            <option value="family">🏠 Family Members</option>
                            <option value="other">🔧 Other (specify below)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label for="customRelationship">Custom Relationship (if "Other" selected):</label>
                        <input type="text" id="customRelationship" placeholder="e.g., therapist-client, teacher-student...">
                    </div>
                    <div class="setting-group">
                        <label for="aiModel">AI Model:</label>
                        <select id="aiModel">
                            <option value="gpt-3.5-turbo">⚡ ChatGPT-3.5 (Fast & Free)</option>
                            <option value="gpt-4">🔍 ChatGPT-4 (Deep & Accurate)</option>
                        </select>
                        <div class="model-tooltip" id="modelTooltip">
                            <strong>⚡ ChatGPT-3.5:</strong> Quick response, lower cost. Great for short or casual analysis.
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Model Information -->
            <div class="ai-model-info">
                <strong>🤖 AI Model Selection:</strong> Choose the right model for your needs
                <div class="model-comparison">
                    <div class="model-option" id="gpt35Option">
                        <h4>⚡ ChatGPT-3.5</h4>
                        <p><strong>Fast & Efficient:</strong> Quick response (2-5 sec), lower cost. Handles conversations up to 1 hour well. Great for quick insights.</p>
                    </div>
                    <div class="model-option" id="gpt4Option">
                        <h4>🔍 ChatGPT-4</h4>
                        <p><strong>Deep & Comprehensive:</strong> Slower response (10-60 sec), higher cost. Excellent for 2+ hour conversations, complex emotions, and nuanced analysis.</p>
                    </div>
                </div>
            </div>

            <!-- Input Method Selection -->
            <div class="input-methods">
                <div class="method-btn active" data-method="record">
                    🎙️ Record Live
                </div>
                <div class="method-btn" data-method="upload">
                    📁 Upload Audio
                </div>
                <div class="method-btn" data-method="type">
                    ✍️ Type/Describe
                </div>
            </div>

            <!-- Recording Section -->
            <div class="input-section" id="recordSection">
                <div class="recording-controls">
                    <button class="record-btn start" id="startRecording">
                        🎙️ Start Recording
                    </button>
                    <button class="record-btn stop hidden" id="stopRecording">
                        ⏹️ Stop Recording
                    </button>
                    <div class="status-indicator hidden" id="recordingStatus">
                        <div class="status-dot"></div>
                        <span>Recording...</span>
                    </div>
                </div>
                <audio id="audioPlayback" controls class="hidden" style="width: 100%; margin-top: 10px;"></audio>
            </div>

            <!-- Upload Section -->
            <div class="input-section hidden" id="uploadSection">
                <label for="audioFile">Upload Audio File:</label>
                <input type="file" id="audioFile" accept="audio/*">
            </div>

            <!-- Type Section -->
            <div class="input-section hidden" id="typeSection">
                <label for="conversationText">Type or Describe Your Conversation:</label>
                <textarea id="conversationText" placeholder="Describe your conversation here..." rows="6"></textarea>
            </div>

            <!-- Transcript Section -->
            <div class="transcript-section">
                <h3>Conversation Transcript</h3>
                <div class="transcript-box" id="transcriptBox">
                    <p style="color: #666; text-align: center;">Your conversation transcript will appear here...</p>
                </div>
            </div>

            <!-- Speaker Management -->
            <div class="speaker-management hidden" id="speakerManagement">
                <h3>Identify Speakers</h3>
                <p style="margin-bottom: 15px;">Name the speakers and select which one is you:</p>
                <div id="speakerList"></div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn summary" id="summaryBtn" disabled>
                    📋 Generate Summary
                </button>
                <button class="action-btn analyze" id="analyzeBtn" disabled>
                    🔍 Analyze My Behavior
                </button>
                <button class="action-btn" id="testConnectionBtn" style="background: #fd7e14; color: white;">
                    🧪 Test OpenAI Connection
                </button>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <div class="result-box hidden" id="summaryResult">
                    <div class="result-title">📋 Conversation Summary</div>
                    <div class="result-content" id="summaryContent"></div>
                </div>

                <div class="result-box hidden" id="analysisResult">
                    <div class="result-title">🔍 Your Behavioral Analysis</div>
                    <div class="result-content" id="analysisContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let mediaRecorder;
        let audioChunks = [];
        let currentTranscript = '';
        let speakers = [];
        let currentMethod = 'record';
        let isRecording = false;
        let recognitionService;

        // Backend Configuration
        const BACKEND_URL = window.location.origin;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Reflect AI...');
            initializeEventListeners();
            setupMethodSwitching();
            testBackendConnection();
            updateModelTooltip();
        });

        function initializeEventListeners() {
            console.log('🔧 Setting up event listeners...');
            
            // Recording controls
            document.getElementById('startRecording').addEventListener('click', startRecording);
            document.getElementById('stopRecording').addEventListener('click', stopRecording);
            
            // File upload
            document.getElementById('audioFile').addEventListener('change', handleFileUpload);
            
            // Text input
            document.getElementById('conversationText').addEventListener('input', handleTextInput);
            
            // Action buttons
            document.getElementById('summaryBtn').addEventListener('click', generateSummary);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeConversation);
            document.getElementById('testConnectionBtn').addEventListener('click', testOpenAIConnection);
            
            // Model selection
            document.getElementById('aiModel').addEventListener('change', updateModelTooltip);
            
            console.log('✅ Event listeners ready');
        }

        function setupMethodSwitching() {
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active button
                    document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('.input-section').forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    // Show selected section
                    currentMethod = this.dataset.method;
                    document.getElementById(currentMethod + 'Section').classList.remove('hidden');
                    
                    // Reset transcript
                    resetTranscript();
                });
            });
        }

        async function testBackendConnection() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Backend connected:', data.message);
                    showSuccess('🟢 Backend server connected - Ready to transcribe and analyze!');
                } else {
                    throw new Error(`Server responded with status ${response.status}`);
                }
            } catch (error) {
                console.log('❌ Backend connection failed:', error.message);
                showError('🟡 Backend offline - Please check server status');
            }
        }

        async function startRecording() {
            try {
                console.log('🎙️ Starting recording...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Use best available audio format
                let options = {};
                if (MediaRecorder.isTypeSupported('audio/wav')) {
                    options = { mimeType: 'audio/wav' };
                } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                    options = { mimeType: 'audio/webm' };
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/wav' });
                    
                    // Show audio player
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioElement = document.getElementById('audioPlayback');
                    audioElement.src = audioUrl;
                    audioElement.classList.remove('hidden');
                    
                    // Transcribe audio
                    await transcribeAudio(audioBlob);
                    
                    // Clean up
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                document.getElementById('startRecording').classList.add('hidden');
                document.getElementById('stopRecording').classList.remove('hidden');
                document.getElementById('recordingStatus').classList.remove('hidden');
                
                showTranscriptMessage('🎙️ Recording in progress... Press stop when finished.');
                
            } catch (error) {
                console.error('Recording error:', error);
                showError('Error accessing microphone: ' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                console.log('⏹️ Stopping recording...');
                mediaRecorder.stop();
                isRecording = false;
                
                // Update UI
                document.getElementById('startRecording').classList.remove('hidden');
                document.getElementById('stopRecording').classList.add('hidden');
                document.getElementById('recordingStatus').classList.add('hidden');
                
                showTranscriptMessage('🤖 Processing your recording...');
            }
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                console.log('📁 File uploaded:', file.name);
                showTranscriptMessage(`📁 File uploaded: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                await transcribeAudio(file);
            }
        }

        function handleTextInput() {
            const text = document.getElementById('conversationText').value;
            if (text.trim()) {
                console.log('✍️ Text input received');
                currentTranscript = text.trim();
                displayTranscript(currentTranscript);
                enableActionButtons();
            }
        }

        async function transcribeAudio(audioBlob) {
            try {
                showLoading('Transcribing with OpenAI Whisper...');
                
                // Create FormData
                const formData = new FormData();
                
                // Determine filename
                let filename = 'recording.wav';
                if (audioBlob.type.includes('webm')) {
                    filename = 'recording.webm';
                } else if (audioBlob.type.includes('mp4')) {
                    filename = 'recording.mp4';
                }
                
                formData.append('audio', audioBlob, filename);
                formData.append('language', document.getElementById('conversationLanguage').value);
                
                const response = await fetch(`${BACKEND_URL}/api/transcribe`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Transcription failed' }));
                    throw new Error(errorData.message || `Transcription failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'completed') {
                    currentTranscript = data.transcript;
                    displayTranscript(currentTranscript);
                    enableActionButtons();
                    showSuccess(`✅ Transcription completed! Language: ${data.language}`);
                } else {
                    throw new Error('Transcription incomplete');
                }
                
            } catch (error) {
                console.error('Transcription error:', error);
                showError('Transcription failed: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function generateSummary() {
            if (!currentTranscript) {
                showError('No transcript available to summarize.');
                return;
            }
            
            try {
                console.log('📋 Generating summary...');
                showLoading('Generating summary...');
                
                const userName = document.getElementById('userName').value || 'User';
                const analysisLanguage = document.getElementById('analysisLanguage').value;
                const relationshipType = document.getElementById('relationshipType').value;
                const customRelationship = document.getElementById('customRelationship').value;
                const selectedModel = document.getElementById('aiModel').value;
                
                // Determine relationship context
                let relationshipContext = '';
                if (relationshipType === 'other' && customRelationship.trim()) {
                    relationshipContext = customRelationship.trim();
                } else {
                    const relationshipMap = {
                        'romantic': analysisLanguage === 'he' ? 'זוג רומנטי' : 'romantic partners',
                        'parent-child': analysisLanguage === 'he' ? 'הורה וילד' : 'parent and child',
                        'friends': analysisLanguage === 'he' ? 'חברים' : 'friends',
                        'colleagues': analysisLanguage === 'he' ? 'עמיתים לעבודה' : 'work colleagues',
                        'family': analysisLanguage === 'he' ? 'בני משפחה' : 'family members'
                    };
                    relationshipContext = relationshipMap[relationshipType] || (analysisLanguage === 'he' ? 'אנשים' : 'people');
                }
                
                let prompt;
                if (analysisLanguage === 'he') {
                    prompt = `אתה מומחה לניתוח שיחות ומאמן אישי. אני רוצה שתכין לי סיכום ברור ושימושי של השיחה שלי. דבר אליי ישירות בגוף שני בעברית טבעית ושוטפת.

השיחה הזאת היא בין ${relationshipContext}. קח את זה בחשבון בסיכום. שמי ${userName}.

אני רוצה שתארגן את הסיכום לפי:
- הנושאים העיקריים שדיברנו עליהם
- נקודות חשובות והחלטות שהתקבלו
- תובנות או דברים חדשים שעלו בשיחה
- משימות או צעדים הבאים שהוזכרו

כתוב בטון אישי וחם, פנה אליי כ"אתה" והתייחס לתרומה שלי לשיחה. תן לי סיכום מפורט אבל לא ארוך מדי.

תמליל השיחה:
${currentTranscript}`;
                } else {
                    prompt = `You are an expert conversation analyst and personal coach. Create a comprehensive summary of the following conversation for ${userName}. 

This conversation is between ${relationshipContext}. Keep this relationship context in mind for your summary.

Please organize your summary by:
- Main topics discussed in the conversation
- Key points and decisions made  
- Important insights or revelations that came up
- Any action items or next steps mentioned

Write in a conversational tone, addressing the user as "you" and referring to their specific contributions to the discussion. Be thorough but concise.

Conversation transcript:
${currentTranscript}`;
                }
                
                const maxTokens = selectedModel === 'gpt-4' ? 3000 : 2000;
                
                const response = await fetch(`${BACKEND_URL}/api/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        maxTokens: maxTokens,
                        language: analysisLanguage,
                        model: selectedModel
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Summary generation failed' }));
                    throw new Error(errorData.message || 'Summary generation failed');
                }
                
                const data = await response.json();
                
                document.getElementById('summaryContent').innerHTML = data.response.replace(/\n/g, '<br>');
                document.getElementById('summaryResult').classList.remove('hidden');
                
                showSuccess('✅ Summary generated successfully!');
                
            } catch (error) {
                console.error('Summary error:', error);
                showError('Error generating summary: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function analyzeConversation() {
            if (!currentTranscript) {
                showError('No transcript available to analyze.');
                return;
            }
            
            try {
                console.log('🔍 Analyzing conversation...');
                showLoading('Analyzing your conversation...');
                
                const userName = document.getElementById('userName').value || 'User';
                const analysisLanguage = document.getElementById('analysisLanguage').value;
                const relationshipType = document.getElementById('relationshipType').value;
                const customRelationship = document.getElementById('customRelationship').value;
                const selectedModel = document.getElementById('aiModel').value;
                
                // Determine relationship context
                let relationshipContext = '';
                if (relationshipType === 'other' && customRelationship.trim()) {
                    relationshipContext = customRelationship.trim();
                } else {
                    const relationshipMap = {
                        'romantic': analysisLanguage === 'he' ? 'זוג רומנטי' : 'romantic partners',
                        'parent-child': analysisLanguage === 'he' ? 'הורה וילד' : 'parent and child',
                        'friends': analysisLanguage === 'he' ? 'חברים' : 'friends',
                        'colleagues': analysisLanguage === 'he' ? 'עמיתים לעבודה' : 'work colleagues',
                        'family': analysisLanguage === 'he' ? 'בני משפחה' : 'family members'
                    };
                    relationshipContext = relationshipMap[relationshipType] || (analysisLanguage === 'he' ? 'אנשים' : 'people');
                }
                
                let prompt;
                if (analysisLanguage === 'he') {
                    prompt = `אתה מאמן אישי ופסיכולוג מנוסה שמתמחה בניתוח תקשורת ויחסים. אתה דובר עברית שפת אם ומתבטא בצורה טבעית וחמה. תפקידך לעזור לאנשים להבין את עצמם טוב יותר דרך הדרך שבה הם מתקשרים.

השיחה שלפניך היא בין ${relationshipContext}. שמי ${userName} ואני רוצה שתנתח את התנהגות התקשורתית שלי ותעזור לי להבין איך אני פועל ביחסים.

דברים שאני רוצה שתתמקד בהם:
- איך אני מתבטא ומתקשר
- מה הסגנון התקשורתי שלי
- איך אני מגיב למצבים שונים בשיחה
- איך התקשורת שלי משפיעה על הקשר הזה
- מה אני יכול לשפר או לשנות
- עצות מעשיות לשיפור התקשורת שלי

דבר אליי ישירות בגוף שני, בטון תומך ומעודד כמו מאמן אישי. כתוב בעברית טבעית ושוטפת, לא בתרגום. תן לי תובנות מעמיקות אבל באופן שאני אוכל לקלוט ולהפעיל בחיים.

תמליל השיחה:
${currentTranscript}`;
                } else {
                    prompt = `You are an experienced personal coach and communication psychologist who specializes in helping people understand themselves through their communication patterns. You have a warm, supportive coaching style that makes people feel understood and empowered.

The conversation you're analyzing is between ${relationshipContext}. My name is ${userName} and I want you to analyze my communication behavior and help me understand how I operate in relationships.

Focus on:
- How I express myself and communicate
- My communication style and patterns
- How I respond to different situations in the conversation
- How my communication affects this relationship dynamic
- What I could improve or change
- Practical advice for better communication

Speak to me directly in second person with a supportive, encouraging tone like a personal coach would. Write in natural, flowing language that feels like a real conversation. Give me deep insights but in a way I can understand and apply in my life.

Conversation transcript:
${currentTranscript}`;
                }
                
                const maxTokens = selectedModel === 'gpt-4' ? 4000 : 2500;
                
                const response = await fetch(`${BACKEND_URL}/api/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        maxTokens: maxTokens,
                        language: analysisLanguage,
                        model: selectedModel
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Analysis failed' }));
                    throw new Error(errorData.message || 'Analysis failed');
                }
                
                const data = await response.json();
                
                document.getElementById('analysisContent').innerHTML = data.response.replace(/\n/g, '<br>');
                document.getElementById('analysisResult').classList.remove('hidden');
                
                showSuccess('✅ Analysis completed successfully!');
                
            } catch (error) {
                console.error('Analysis error:', error);
                showError('Error analyzing conversation: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function testOpenAIConnection() {
            try {
                console.log('🧪 Testing OpenAI connection...');
                showLoading('Testing OpenAI connection...');
                
                const response = await fetch(`${BACKEND_URL}/api/test`);
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(`✅ OpenAI connection working! Response: "${data.test_response}"`);
                } else {
                    showError(`❌ OpenAI test failed: ${data.message}`);
                }
                
            } catch (error) {
                console.error('Test error:', error);
                showError(`❌ Connection test failed: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function displayTranscript(transcript) {
            const transcriptBox = document.getElementById('transcriptBox');
            const lines = transcript.split('\n').filter(line => line.trim());
            
            transcriptBox.innerHTML = '';
            
            const uniqueSpeakers = new Set();
            
            lines.forEach(line => {
                const speakerMatch = line.match(/^(Speaker [A-Z]|[^:]+):\s*(.+)$/);
                if (speakerMatch) {
                    const speaker = speakerMatch[1];
                    const text = speakerMatch[2];
                    uniqueSpeakers.add(speaker);
                    
                    const speakerLine = document.createElement('div');
                    speakerLine.className = 'speaker-line';
                    speakerLine.innerHTML = `
                        <div class="speaker-name">${speaker}</div>
                        <div class="speaker-text">${text}</div>
                    `;
                    transcriptBox.appendChild(speakerLine);
                } else {
                    // Handle plain text without speaker labels
                    const textLine = document.createElement('div');
                    textLine.className = 'speaker-line';
                    textLine.innerHTML = `
                        <div class="speaker-text">${line}</div>
                    `;
                    transcriptBox.appendChild(textLine);
                }
            });
            
            // Update speaker management if speakers found
            if (uniqueSpeakers.size > 0) {
                updateSpeakerManagement(Array.from(uniqueSpeakers));
            }
        }

        function updateSpeakerManagement(speakerList) {
            speakers = speakerList;
            const speakerManagement = document.getElementById('speakerManagement');
            const speakerListDiv = document.getElementById('speakerList');
            
            if (speakers.length > 0) {
                speakerManagement.classList.remove('hidden');
                speakerListDiv.innerHTML = '';
                
                speakers.forEach((speaker, index) => {
                    const speakerItem = document.createElement('div');
                    speakerItem.className = 'speaker-item';
                    speakerItem.innerHTML = `
                        <div class="speaker-label">${speaker}</div>
                        <input type="text" class="speaker-name-input" placeholder="Enter name..." value="${speaker}">
                        <label>
                            <input type="radio" name="isMe" class="is-me-checkbox" value="${index}">
                            This is me
                        </label>
                    `;
                    speakerListDiv.appendChild(speakerItem);
                });
            }
        }

        function enableActionButtons() {
            document.getElementById('summaryBtn').disabled = false;
            document.getElementById('analyzeBtn').disabled = false;
        }

        function resetTranscript() {
            currentTranscript = '';
            document.getElementById('transcriptBox').innerHTML = '<p style="color: #666; text-align: center;">Your conversation transcript will appear here...</p>';
            document.getElementById('speakerManagement').classList.add('hidden');
            document.getElementById('summaryResult').classList.add('hidden');
            document.getElementById('analysisResult').classList.add('hidden');
            document.getElementById('summaryBtn').disabled = true;
            document.getElementById('analyzeBtn').disabled = true;
        }

        function showTranscriptMessage(message) {
            const transcriptBox = document.getElementById('transcriptBox');
            transcriptBox.innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                    <p>${message}</p>
                </div>
            `;
        }

        function showLoading(message) {
            hideLoading(); // Remove any existing loading indicators
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.innerHTML = `
                <div class="spinner"></div>
                <span>${message}</span>
            `;
            
            document.querySelector('.main-card').appendChild(loadingDiv);
        }

        function hideLoading() {
            document.querySelectorAll('.loading').forEach(el => el.remove());
        }

        function showError(message) {
            document.querySelectorAll('.error').forEach(el => el.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const mainCard = document.querySelector('.main-card');
            mainCard.insertBefore(errorDiv, mainCard.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            document.querySelectorAll('.success').forEach(el => el.remove());
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const mainCard = document.querySelector('.main-card');
            mainCard.insertBefore(successDiv, mainCard.firstChild);
            
            setTimeout(() => successDiv.remove(), 5000);
        }

        function updateModelTooltip() {
            const selectedModel = document.getElementById('aiModel').value;
            const tooltip = document.getElementById('modelTooltip');
            const gpt35Option = document.getElementById('gpt35Option');
            const gpt4Option = document.getElementById('gpt4Option');
            
            // Update tooltip text
            if (selectedModel === 'gpt-4') {
                tooltip.innerHTML = '<strong>🔍 ChatGPT-4:</strong> Slower but more intelligent. Perfect for long conversations (2+ hours), complex emotions, and deep psychological insights.';
                tooltip.style.background = '#f8e6ff';
                tooltip.style.borderColor = '#d4c5f9';
                tooltip.style.color = '#5a2d82';
                
                // Update visual selection
                gpt4Option.classList.add('selected');
                gpt35Option.classList.remove('selected');
            } else {
                tooltip.innerHTML = '<strong>⚡ ChatGPT-3.5:</strong> Quick response, lower cost. Handles conversations up to 1 hour well. Great for fast insights.';
                tooltip.style.background = '#e8f4fd';
                tooltip.style.borderColor = '#bee5eb';
                tooltip.style.color = '#0c5460';
                
                // Update visual selection
                gpt35Option.classList.add('selected');
                gpt4Option.classList.remove('selected');
            }
        }
    </script>
</body>
</html>